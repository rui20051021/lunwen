# 实时预警功能实施指南

> **实施时间**: 2025-12-29  
> **实施内容**: WebSocket实时推送 + 三类预警自动触发 + 预警处理反馈

---

## 📋 已完成的功能

### 1. WebSocket实时推送 ✅

#### 后端实现
- ✅ `WebSocketHandler.java` - WebSocket处理器
  - 管理用户会话连接
  - 向指定用户推送预警消息
  - 支持广播消息
  - 自动处理连接断开和重连

- ✅ `WebSocketConfig.java` - WebSocket配置
  - 注册WebSocket端点: `ws://localhost:8080/ws/alerts?userId={userId}`
  - 启用SockJS支持（兼容不支持WebSocket的浏览器）

#### 前端实现
- ✅ `websocket.ts` - WebSocket客户端工具
  - 自动连接和重连机制
  - 心跳保活
  - 预警消息实时通知
  - 事件监听机制

- ✅ `App.vue` - 集成WebSocket
  - 用户登录后自动建立连接
  - 监听预警点击事件

---

### 2. 实时预警触发机制 ✅

#### AlertService.java - 预警服务
实现了三类预警的自动触发：

##### 2.1 超时预警 ✅
- **触发方式**: 定时任务（每分钟检查一次）
- **检测逻辑**:
  ```java
  @Scheduled(fixedRate = 60000) // 每60秒执行一次
  public void checkTimeoutAlerts()
  ```
- **判断条件**: 当前时间 - 计划到达时间 > 最大延迟容忍时长
- **预警级别**: high（高）
- **推送对象**: 供应商、采购商

##### 2.2 温控预警 ✅
- **触发方式**: Kafka消费者实时检测
- **检测逻辑**:
  ```java
  @KafkaListener(topics = "sensor-temperature")
  public void consumeTemperatureData(String message)
  ```
- **判断条件**: 温度 < 最低温度 OR 温度 > 最高温度
- **预警级别**: critical（严重）
- **推送对象**: 供应商、采购商
- **防重复**: 5分钟内不重复预警

##### 2.3 路径偏离预警 ✅
- **触发方式**: Kafka消费者实时检测
- **检测逻辑**:
  ```java
  @KafkaListener(topics = "sensor-gps")
  public void consumeGpsData(String message)
  ```
- **判断条件**: 车辆位置到预设路线的最短距离 > 偏离阈值
- **预警级别**: medium（中）
- **推送对象**: 供应商、采购商
- **防重复**: 10分钟内不重复预警

---

### 3. 预警处理反馈 ✅

#### AlertProcessController.java - 预警处理控制器
提供完整的预警处理API：

- ✅ `POST /api/alerts/{alertId}/process` - 开始处理预警
- ✅ `POST /api/alerts/{alertId}/complete` - 完成预警处理
- ✅ `POST /api/alerts/{alertId}/ignore` - 忽略预警
- ✅ `POST /api/alerts/{alertId}/false-alarm` - 标记为误报

#### AlertProcessDialog.vue - 预警处理对话框
- ✅ 支持开始处理、完成处理、忽略预警
- ✅ 表单验证
- ✅ 预警信息展示

---

### 4. Kafka消费者服务 ✅

#### KafkaConsumerService.java
- ✅ 消费温湿度传感器数据（topic: sensor-temperature）
- ✅ 消费GPS定位数据（topic: sensor-gps）
- ✅ 保存传感器数据到数据库
- ✅ 触发实时预警检测

---

### 5. 传感器数据模拟器 ✅

#### SensorSimulatorController.java
提供测试接口：

- ✅ `POST /api/simulator/temperature` - 模拟温度数据
- ✅ `POST /api/simulator/gps` - 模拟GPS数据
- ✅ `POST /api/simulator/temperature-abnormal` - 模拟温度异常
- ✅ `POST /api/simulator/batch` - 批量模拟数据（压力测试）

---

## 🚀 快速测试指南

### 步骤1: 启动后端服务

```bash
cd backend
mvn spring-boot:run
```

确保以下服务已启动：
- MySQL (端口3306)
- Redis (端口6379)
- Kafka (端口9092)

### 步骤2: 启动前端服务

```bash
cd frontend
npm run dev
```

访问: http://localhost:3000

### 步骤3: 登录系统

使用任意角色账号登录，系统会自动建立WebSocket连接。

### 步骤4: 测试实时预警

#### 4.1 测试温控预警

使用Postman或curl发送请求：

```bash
# 模拟温度过高（触发预警）
curl -X POST "http://localhost:8080/api/simulator/temperature-abnormal?vehicleId=1&abnormalType=high"

# 模拟温度过低（触发预警）
curl -X POST "http://localhost:8080/api/simulator/temperature-abnormal?vehicleId=1&abnormalType=low"

# 模拟正常温度（不触发预警）
curl -X POST "http://localhost:8080/api/simulator/temperature?vehicleId=1&temperature=5.0"
```

**预期结果**:
- 前端右上角弹出预警通知
- 预警级别为"严重"（红色）
- 点击通知可跳转到预警详情

#### 4.2 测试超时预警

超时预警由定时任务自动检测（每分钟执行一次）。

**测试方法**:
1. 在数据库中创建一个运输任务
2. 设置 `planned_arrival_time` 为过去的时间（如1小时前）
3. 设置 `transport_status` 为 'in_transit'
4. 等待1分钟，系统会自动触发超时预警

```sql
-- 创建测试数据
UPDATE transports 
SET planned_arrival_time = DATE_SUB(NOW(), INTERVAL 2 HOUR),
    transport_status = 'in_transit'
WHERE id = 1;
```

**预期结果**:
- 1分钟内前端收到超时预警通知
- 预警级别为"高"（红色）

#### 4.3 测试路径偏离预警

```bash
# 模拟GPS数据（偏离路线）
curl -X POST "http://localhost:8080/api/simulator/gps?vehicleId=1&latitude=40.5&longitude=117.0"
```

**预期结果**:
- 前端收到路径偏离预警通知
- 预警级别为"中"（橙色）

#### 4.4 测试预警处理

1. 点击预警通知或进入预警列表页面
2. 点击"开始处理"按钮
3. 填写处理说明，提交
4. 处理完成后，点击"完成处理"按钮
5. 填写处理结果，提交

**预期结果**:
- 预警状态从 pending → processing → processed
- 数据库记录处理人、处理时间、处理结果

---

## 📊 性能测试

### 测试1: 预警响应延迟

**目标**: ≤ 3秒

**测试方法**:
```bash
# 批量发送1000条温度异常数据
curl -X POST "http://localhost:8080/api/simulator/batch?count=1000&vehicleIdStart=1"
```

**测量指标**:
- 从数据发送到前端收到预警的时间
- 平均响应时间
- 最大响应时间

### 测试2: 数据处理吞吐量

**目标**: ≥ 5万条/秒

**测试方法**:
使用JMeter或Kafka性能测试工具进行压测。

---

## 🔧 配置说明

### 后端配置

#### application.yml
```yaml
# Kafka配置
spring:
  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      group-id: freshlogistics-group
      auto-offset-reset: earliest
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer

# 定时任务配置
spring:
  task:
    scheduling:
      pool:
        size: 5
```

### 前端配置

#### WebSocket连接地址
```typescript
// src/utils/websocket.ts
const wsUrl = `ws://localhost:8080/ws/alerts?userId=${userId}`
```

**生产环境需要修改为**:
```typescript
const wsUrl = `wss://your-domain.com/ws/alerts?userId=${userId}`
```

---

## 📝 数据库表结构

### alert_records - 预警记录表

```sql
CREATE TABLE alert_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  alert_code VARCHAR(50) UNIQUE NOT NULL COMMENT '预警编号',
  alert_type VARCHAR(20) NOT NULL COMMENT '预警类型: timeout, temperature, route_deviation',
  alert_level VARCHAR(20) NOT NULL COMMENT '预警级别: critical, high, medium, low',
  alert_title VARCHAR(200) NOT NULL COMMENT '预警标题',
  alert_message TEXT COMMENT '预警消息',
  related_id BIGINT COMMENT '关联ID（运输任务ID）',
  related_type VARCHAR(50) COMMENT '关联类型: transport',
  alert_status VARCHAR(20) DEFAULT 'pending' COMMENT '预警状态: pending, processing, processed, ignored',
  processor_id BIGINT COMMENT '处理人ID',
  process_time DATETIME COMMENT '处理时间',
  process_notes TEXT COMMENT '处理说明',
  process_result TEXT COMMENT '处理结果',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_alert_type (alert_type),
  INDEX idx_alert_status (alert_status),
  INDEX idx_related (related_id, related_type),
  INDEX idx_created_at (created_at)
);
```

---

## 🐛 常见问题

### 1. WebSocket连接失败

**问题**: 前端无法连接WebSocket

**解决方案**:
- 检查后端是否启动
- 检查WebSocket端口是否被占用
- 检查防火墙设置
- 查看浏览器控制台错误信息

### 2. 预警未触发

**问题**: 发送传感器数据后没有收到预警

**解决方案**:
- 检查Kafka是否正常运行
- 检查数据库中是否有对应的运输任务
- 检查预警规则是否配置正确
- 查看后端日志

### 3. 定时任务未执行

**问题**: 超时预警未自动触发

**解决方案**:
- 确认 `@EnableScheduling` 注解已添加
- 检查定时任务配置
- 查看后端日志

---

## 📈 下一步优化建议

### 1. 路径偏离算法优化
当前使用简化的距离计算，建议实现：
- 点到线段的最短距离计算（Haversine公式）
- 考虑道路网络的实际路径
- 集成高德地图路径规划API

### 2. BP神经网络模型（可选）
如果需要更智能的温控预警，可以：
- 使用Python训练BP神经网络模型
- 通过REST API调用模型预测
- 实现温度趋势预测

### 3. Flink实时计算引擎（可选）
如果需要更高的实时性和吞吐量，可以：
- 集成Apache Flink
- 实现流式计算
- 提升预警响应速度

### 4. 预警规则优化
- 支持更复杂的规则表达式
- 支持规则优先级
- 支持规则组合（AND/OR逻辑）

---

## ✅ 功能完成度

| 功能模块 | 完成度 | 状态 |
|---------|--------|------|
| WebSocket实时推送 | 100% | ✅ 已完成 |
| 超时预警触发 | 100% | ✅ 已完成 |
| 温控预警触发 | 100% | ✅ 已完成 |
| 路径偏离预警触发 | 90% | ✅ 基本完成（算法可优化） |
| 预警处理反馈 | 100% | ✅ 已完成 |
| Kafka消费者 | 100% | ✅ 已完成 |
| 传感器数据模拟 | 100% | ✅ 已完成 |

**总体完成度**: **95%**

---

**实施完成时间**: 2025-12-29  
**下一步**: 进行性能测试和用户验收测试
